# =============================================================================
# Postiz - eblej24.com Integration
# =============================================================================
# Social media scheduling and management platform
# Accessible at: https://social.eblej24.com
#
# Data Storage:
#   postgres_data volume - PostgreSQL database (Docker managed)
#   elasticsearch_data   - Elasticsearch data (Docker managed)
#   ./data/redis/        - Redis persistence
#   ./data/postiz/       - Application config and uploads
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # POSTIZ - Main Application
  # ---------------------------------------------------------------------------
  eb24-postiz-app:
    image: ghcr.io/gitroomhq/postiz-app:v2.12.1
    container_name: eb24-postiz-app
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # === Required Settings
      MAIN_URL: ${POSTIZ_MAIN_URL:-https://social.eblej24.com}
      FRONTEND_URL: ${POSTIZ_FRONTEND_URL:-https://social.eblej24.com}
      NEXT_PUBLIC_BACKEND_URL: ${POSTIZ_BACKEND_URL:-https://social.eblej24.com/api}
      JWT_SECRET: ${POSTIZ_JWT_SECRET:?POSTIZ_JWT_SECRET is required}
      # Database URL built from postgres credentials (no separate variable needed)
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@eb24-postiz-postgres:5432/${POSTIZ_DB:-postiz}
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD}@eb24-postiz-redis:6379}
      BACKEND_INTERNAL_URL: http://localhost:3000
      TEMPORAL_ADDRESS: eb24-postiz-temporal:7233
      IS_GENERAL: 'true'
      DISABLE_REGISTRATION: ${POSTIZ_DISABLE_REGISTRATION:-false}

      # === Storage Settings
      STORAGE_PROVIDER: ${POSTIZ_STORAGE_PROVIDER:-local}
      UPLOAD_DIRECTORY: /uploads
      NEXT_PUBLIC_UPLOAD_DIRECTORY: /uploads

      # === Email Settings
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-}

      # === Social Media API Settings
      X_API_KEY: ${X_API_KEY:-}
      X_API_SECRET: ${X_API_SECRET:-}
      LINKEDIN_CLIENT_ID: ${LINKEDIN_CLIENT_ID:-}
      LINKEDIN_CLIENT_SECRET: ${LINKEDIN_CLIENT_SECRET:-}
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID:-}
      REDDIT_CLIENT_SECRET: ${REDDIT_CLIENT_SECRET:-}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      BEEHIIVE_API_KEY: ${BEEHIIVE_API_KEY:-}
      BEEHIIVE_PUBLICATION_ID: ${BEEHIIVE_PUBLICATION_ID:-}
      THREADS_APP_ID: ${THREADS_APP_ID:-}
      THREADS_APP_SECRET: ${THREADS_APP_SECRET:-}
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID:-}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET:-}
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID:-}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET:-}
      TIKTOK_CLIENT_ID: ${TIKTOK_CLIENT_ID:-}
      TIKTOK_CLIENT_SECRET: ${TIKTOK_CLIENT_SECRET:-}
      PINTEREST_CLIENT_ID: ${PINTEREST_CLIENT_ID:-}
      PINTEREST_CLIENT_SECRET: ${PINTEREST_CLIENT_SECRET:-}
      DRIBBBLE_CLIENT_ID: ${DRIBBBLE_CLIENT_ID:-}
      DRIBBBLE_CLIENT_SECRET: ${DRIBBBLE_CLIENT_SECRET:-}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:-}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET:-}
      DISCORD_BOT_TOKEN_ID: ${DISCORD_BOT_TOKEN_ID:-}
      SLACK_ID: ${SLACK_ID:-}
      SLACK_SECRET: ${SLACK_SECRET:-}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET:-}
      MASTODON_URL: ${MASTODON_URL:-https://mastodon.social}
      MASTODON_CLIENT_ID: ${MASTODON_CLIENT_ID:-}
      MASTODON_CLIENT_SECRET: ${MASTODON_CLIENT_SECRET:-}

      # === Misc Settings
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      NEXT_PUBLIC_DISCORD_SUPPORT: ${NEXT_PUBLIC_DISCORD_SUPPORT:-}
      NEXT_PUBLIC_POLOTNO: ${NEXT_PUBLIC_POLOTNO:-}
      API_LIMIT: ${API_LIMIT:-30}

      # === Payment / Stripe Settings
      FEE_AMOUNT: ${FEE_AMOUNT:-0.05}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_SIGNING_KEY: ${STRIPE_SIGNING_KEY:-}
      STRIPE_SIGNING_KEY_CONNECT: ${STRIPE_SIGNING_KEY_CONNECT:-}

      # === Developer Settings
      NX_ADD_PLUGINS: false
    volumes:
      - ./data/postiz/config:/config/
      - ./data/postiz/uploads:/uploads/
    networks:
      - public
      - internal
    depends_on:
      eb24-postiz-postgres:
        condition: service_healthy
      eb24-postiz-redis:
        condition: service_healthy
      eb24-postiz-temporal:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ---------------------------------------------------------------------------
  # POSTGRES - Shared Database (internal only)
  # ---------------------------------------------------------------------------
  # Single PostgreSQL instance with multiple databases:
  #   - postiz: Main application database
  #   - temporal: Workflow engine database
  #   - temporal_visibility: Temporal visibility database
  eb24-postiz-postgres:
    image: postgres:17-alpine
    container_name: eb24-postiz-postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: postgres
      # Additional databases created via init script
      POSTIZ_DB: ${POSTIZ_DB:-postiz}
      TEMPORAL_DB: ${TEMPORAL_DB:-temporal}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./config/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # POSTIZ REDIS - Cache (internal only)
  # ---------------------------------------------------------------------------
  eb24-postiz-redis:
    image: redis:7.2-alpine
    container_name: eb24-postiz-redis
    restart: unless-stopped
    command: >
      sh -c 'redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass "$REDIS_PASSWORD"}'
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - ./data/redis:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ${REDIS_PASSWORD:+-a $REDIS_PASSWORD} ping | grep -q PONG"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # ELASTICSEARCH - Search engine for Temporal visibility
  # ---------------------------------------------------------------------------
  eb24-postiz-elasticsearch:
    image: elasticsearch:7.17.27
    container_name: eb24-postiz-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - cluster.routing.allocation.disk.threshold_enabled=true
      - cluster.routing.allocation.disk.watermark.low=512mb
      - cluster.routing.allocation.disk.watermark.high=256mb
      - cluster.routing.allocation.disk.watermark.flood_stage=128mb
      - ES_JAVA_OPTS=-Xms256m -Xmx512m
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -vq '\"status\":\"red\"'"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 90s

  # ---------------------------------------------------------------------------
  # TEMPORAL - Workflow Engine (PostgreSQL + Elasticsearch)
  # ---------------------------------------------------------------------------
  eb24-postiz-temporal:
    image: temporalio/auto-setup:1.28.1
    container_name: eb24-postiz-temporal
    restart: unless-stopped
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PWD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_SEEDS=eb24-postiz-postgres
      - DBNAME=${TEMPORAL_DB:-temporal}
      - ENABLE_ES=true
      - ES_SEEDS=eb24-postiz-elasticsearch
      - ES_VERSION=v7
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
    volumes:
      - ./config/temporal/dynamicconfig:/etc/temporal/config/dynamicconfig
    networks:
      - internal
    depends_on:
      eb24-postiz-postgres:
        condition: service_healthy
      eb24-postiz-elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/7233' 2>/dev/null || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 120s

  # ---------------------------------------------------------------------------
  # TEMPORAL UI - Workflow Management Interface (internal only, access via VPN)
  # ---------------------------------------------------------------------------
  eb24-postiz-temporal-ui:
    image: temporalio/ui:2.34.0
    container_name: eb24-postiz-temporal-ui
    restart: unless-stopped
    environment:
      - TEMPORAL_ADDRESS=eb24-postiz-temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:8080
    networks:
      - internal
    depends_on:
      - eb24-postiz-temporal
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ---------------------------------------------------------------------------
  # TEMPORAL ADMIN TOOLS - CLI Tools (optional, for debugging)
  # ---------------------------------------------------------------------------
  eb24-postiz-temporal-admin:
    image: temporalio/admin-tools:1.28.1-tctl-1.18.4-cli-1.4.1
    container_name: eb24-postiz-temporal-admin
    restart: unless-stopped
    environment:
      - TEMPORAL_ADDRESS=eb24-postiz-temporal:7233
      - TEMPORAL_CLI_ADDRESS=eb24-postiz-temporal:7233
    networks:
      - internal
    stdin_open: true
    tty: true
    depends_on:
      - eb24-postiz-temporal

# =============================================================================
# VOLUMES - Named volumes for persistent data
# =============================================================================
volumes:
  postgres_data:
    name: eb24-postiz-postgres-data
  elasticsearch_data:
    name: eb24-postiz-elasticsearch-data

# =============================================================================
# NETWORKS - Connect to existing eblej24 infrastructure
# =============================================================================
networks:
  public:
    external: true
    name: eblej24_public

  internal:
    external: true
    name: eblej24_internal
