# =============================================================================
# Postiz - eblej24.com Integration
# =============================================================================
# Social media scheduling and management platform
# Accessible at: https://social.eblej24.com
#
# Data Storage: All persistent data stored in ./data/ for easy backup
#   ./data/postgres/    - PostgreSQL database files
#   ./data/redis/       - Redis persistence
#   ./data/postiz/      - Application config and uploads
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # POSTIZ - Main Application
  # ---------------------------------------------------------------------------
  postiz:
    image: ghcr.io/gitroomhq/postiz-app:latest
    container_name: postiz
    restart: unless-stopped
    environment:
      # === Required Settings
      MAIN_URL: ${POSTIZ_MAIN_URL:-https://social.eblej24.com}
      FRONTEND_URL: ${POSTIZ_FRONTEND_URL:-https://social.eblej24.com}
      NEXT_PUBLIC_BACKEND_URL: ${POSTIZ_BACKEND_URL:-https://social.eblej24.com/api}
      JWT_SECRET: ${POSTIZ_JWT_SECRET}
      DATABASE_URL: ${POSTIZ_DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/postiz}
      REDIS_URL: redis://postiz-redis:6379
      BACKEND_INTERNAL_URL: http://localhost:3000
      TEMPORAL_ADDRESS: temporal:7233
      IS_GENERAL: 'true'
      DISABLE_REGISTRATION: ${POSTIZ_DISABLE_REGISTRATION:-false}

      # === Storage Settings
      STORAGE_PROVIDER: ${POSTIZ_STORAGE_PROVIDER:-local}
      UPLOAD_DIRECTORY: /uploads
      NEXT_PUBLIC_UPLOAD_DIRECTORY: /uploads

      # === Social Media API Settings
      X_API_KEY: ${X_API_KEY:-}
      X_API_SECRET: ${X_API_SECRET:-}
      LINKEDIN_CLIENT_ID: ${LINKEDIN_CLIENT_ID:-}
      LINKEDIN_CLIENT_SECRET: ${LINKEDIN_CLIENT_SECRET:-}
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID:-}
      REDDIT_CLIENT_SECRET: ${REDDIT_CLIENT_SECRET:-}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      BEEHIIVE_API_KEY: ${BEEHIIVE_API_KEY:-}
      BEEHIIVE_PUBLICATION_ID: ${BEEHIIVE_PUBLICATION_ID:-}
      THREADS_APP_ID: ${THREADS_APP_ID:-}
      THREADS_APP_SECRET: ${THREADS_APP_SECRET:-}
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID:-}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET:-}
      YOUTUBE_CLIENT_ID: ${YOUTUBE_CLIENT_ID:-}
      YOUTUBE_CLIENT_SECRET: ${YOUTUBE_CLIENT_SECRET:-}
      TIKTOK_CLIENT_ID: ${TIKTOK_CLIENT_ID:-}
      TIKTOK_CLIENT_SECRET: ${TIKTOK_CLIENT_SECRET:-}
      PINTEREST_CLIENT_ID: ${PINTEREST_CLIENT_ID:-}
      PINTEREST_CLIENT_SECRET: ${PINTEREST_CLIENT_SECRET:-}
      DRIBBBLE_CLIENT_ID: ${DRIBBBLE_CLIENT_ID:-}
      DRIBBBLE_CLIENT_SECRET: ${DRIBBBLE_CLIENT_SECRET:-}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:-}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET:-}
      DISCORD_BOT_TOKEN_ID: ${DISCORD_BOT_TOKEN_ID:-}
      SLACK_ID: ${SLACK_ID:-}
      SLACK_SECRET: ${SLACK_SECRET:-}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET:-}
      MASTODON_URL: ${MASTODON_URL:-https://mastodon.social}
      MASTODON_CLIENT_ID: ${MASTODON_CLIENT_ID:-}
      MASTODON_CLIENT_SECRET: ${MASTODON_CLIENT_SECRET:-}

      # === Misc Settings
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      NEXT_PUBLIC_DISCORD_SUPPORT: ${NEXT_PUBLIC_DISCORD_SUPPORT:-}
      NEXT_PUBLIC_POLOTNO: ${NEXT_PUBLIC_POLOTNO:-}
      API_LIMIT: ${API_LIMIT:-30}

      # === Payment / Stripe Settings
      FEE_AMOUNT: ${FEE_AMOUNT:-0.05}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_SIGNING_KEY: ${STRIPE_SIGNING_KEY:-}
      STRIPE_SIGNING_KEY_CONNECT: ${STRIPE_SIGNING_KEY_CONNECT:-}

      # === Developer Settings
      NX_ADD_PLUGINS: false
    volumes:
      - ./data/postiz/config:/config/
      - ./data/postiz/uploads:/uploads/
    networks:
      - public
      - internal
    depends_on:
      postgres:
        condition: service_healthy
      postiz-redis:
        condition: service_healthy
      temporal:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    cap_drop:
      - ALL

  # ---------------------------------------------------------------------------
  # POSTGRES - Shared Database (internal only)
  # ---------------------------------------------------------------------------
  # Single PostgreSQL instance with multiple databases:
  #   - postiz: Main application database
  #   - temporal: Workflow engine database
  #   - temporal_visibility: Temporal visibility database
  postgres:
    image: postgres:17-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: postgres
      # Additional databases created via init script
      POSTIZ_DB: ${POSTIZ_DB:-postiz}
      TEMPORAL_DB: ${TEMPORAL_DB:-temporal}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./config/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  # ---------------------------------------------------------------------------
  # POSTIZ REDIS - Cache (internal only)
  # ---------------------------------------------------------------------------
  postiz-redis:
    image: redis:7.2-alpine
    container_name: postiz-redis
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    cap_drop:
      - ALL

  # ---------------------------------------------------------------------------
  # TEMPORAL - Workflow Engine (PostgreSQL backend, no Elasticsearch)
  # ---------------------------------------------------------------------------
  temporal:
    image: temporalio/auto-setup:1.28.1
    container_name: temporal
    restart: unless-stopped
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PWD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_SEEDS=postgres
      - DBNAME=${TEMPORAL_DB:-temporal}
      - VISIBILITY_DBNAME=${TEMPORAL_DB:-temporal}_visibility
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
      - ENABLE_ES=false
    volumes:
      - ./config/temporal/dynamicconfig:/etc/temporal/config/dynamicconfig
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 7233 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    cap_drop:
      - ALL

  # ---------------------------------------------------------------------------
  # TEMPORAL UI - Workflow Management Interface (internal only, access via VPN)
  # ---------------------------------------------------------------------------
  temporal-ui:
    image: temporalio/ui:2.34.0
    container_name: temporal-ui
    restart: unless-stopped
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:8080
    networks:
      - internal
    depends_on:
      - temporal
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    cap_drop:
      - ALL

  # ---------------------------------------------------------------------------
  # TEMPORAL ADMIN TOOLS - CLI Tools (optional, for debugging)
  # ---------------------------------------------------------------------------
  temporal-admin-tools:
    image: temporalio/admin-tools:1.28.1-tctl-1.18.4-cli-1.4.1
    container_name: temporal-admin-tools
    restart: unless-stopped
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CLI_ADDRESS=temporal:7233
    networks:
      - internal
    stdin_open: true
    tty: true
    depends_on:
      - temporal
    cap_drop:
      - ALL

# =============================================================================
# NETWORKS - Connect to existing eblej24 infrastructure
# =============================================================================
networks:
  public:
    external: true
    name: eblej24_public

  internal:
    external: true
    name: eblej24_internal
